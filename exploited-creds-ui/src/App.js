import React, { useState } from 'react';
import axios from 'axios';

function App() {
  const [searchInput, setSearchInput] = useState('');
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const handleSearch = async () => {
    if (!searchInput.trim()) {
      setError('Search input is required.');
      return;
    }

    setLoading(true);
    setError(null);
    setData([]);

    try {
      //call the api to get the compromised accounts based on the input 
      // const response = await axios.get(`http://127.0.0.1:8080/v1/compromised?filter=${searchInput}`); //the underlying api will figure out if the filter is an email or domain
      const response = await axios.get(`https://d08c84xwb6.execute-api.us-east-2.amazonaws.com/v1/compromised?filter=${searchInput}`);

      const { credlist, errorCount } = response.data;

      if (response.data.errorCount > 0) {
        setError('One or more errors encountered while looking up the results');
        // Always update the table with the available data
        setData(credlist || []);
      } else if (response.data.credlist === null || response.data.credlist.length === 0) { //nothing returned, bail and let the user know
        setError('No results found for the provided search input.');
      } else {
        setData(response.data.credlist);
      }
    } catch (err) {
      if (err.response && err.response.data && err.response.data.message) {
        setError(err.response.data.message); // Display API-provided error message
      } else {
        setError('Failed to fetch data. Please try again.'); // hopefully this doesn't happen...
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="App" style={{ padding: '20px' }}>
      <h1>Search Credentials by Email or Domain</h1>
      
      <div style={{ marginBottom: '20px' }}>
        <input
          type="text"
          value={searchInput}
          onChange={(e) => setSearchInput(e.target.value)}
          placeholder="Enter full email or domain (e.g., example.com)"
          style={{ padding: '10px', width: '300px', marginRight: '10px' }}
        />
        <button
          onClick={handleSearch}
          style={{ padding: '10px 20px', cursor: 'pointer' }}
        >
          Search
        </button>
      </div>
      
      {loading && <div>Loading...</div>}
      {error && <div style={{ color: 'red' }}>{error}</div>}
      
      {data.length > 0 && (
        <table border="1" cellPadding="10" style={{ width: '100%', textAlign: 'left' }}>
          <thead>
            <tr>
              <th>Username</th>
              <th>Domain</th>
              <th>Email</th>
              <th>Passwords</th>
            </tr>
          </thead>
          <tbody>
            {data.map((item, index) => (
              <tr key={index}>
                <td>{item.username}</td>
                <td>{item.domain}</td>
                <td>{item.email}</td>
                <td>{item.password.map(pwd => `[${pwd}]`).join(' ')}</td>
              </tr>
            ))}
          </tbody>
        </table>
      )}
    </div>
  );
}

export default App;
